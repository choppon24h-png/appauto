(function(){'use strict';const form=document.getElementById('generate-form');if(form){form.addEventListener('submit',async function(e){e.preventDefault();clearErrors();const veiculoId=document.getElementById('veiculo_id').value;const segmento=document.getElementById('segmento').value;let hasError=false;if(!veiculoId){showError('veiculo_id','Selecione um veículo');hasError=true}if(!segmento){showError('segmento','Selecione o segmento');hasError=true}if(hasError)return;const btn=document.getElementById('submit-btn');const btnText=btn.querySelector('.btn-text');const btnLoading=btn.querySelector('.btn-loading');btn.disabled=true;btnText.style.display='none';btnLoading.style.display='inline';try{const response=await fetch('/cliente/autenticacao/gerar',{method:'POST',headers:{'X-Requested-With':'XMLHttpRequest'},body:new FormData(this)});const result=await response.json();if(result.sucesso){document.getElementById('token-value').textContent=result.token;document.getElementById('token-expiry').textContent=result.expira_em;document.getElementById('token-modal').style.display='flex';document.body.style.overflow='hidden'}else{if(result.erros){for(const[field,message]of Object.entries(result.erros)){showError(field,message)}}else{showMessage('error',result.mensagem||'Erro ao gerar token')}btn.disabled=false;btnText.style.display='inline';btnLoading.style.display='none'}}catch(error){console.error('Erro:',error);showMessage('error','Erro ao processar requisição');btn.disabled=false;btnText.style.display='inline';btnLoading.style.display='none'}})}window.closeTokenModal=function(){document.getElementById('token-modal').style.display='none';document.body.style.overflow=''};window.copyToken=function(){const tokenValue=document.getElementById('token-value').textContent;navigator.clipboard.writeText(tokenValue).then(()=>{showMessage('success','Token copiado!')})};window.approveAuth=async function(id){if(!confirm('Aprovar este acesso?'))return;await processAuth(id,'aprovar','Acesso aprovado com sucesso')};window.denyAuth=async function(id){if(!confirm('Negar este acesso?'))return;await processAuth(id,'negar','Acesso negado')};window.revokeAuth=async function(id){if(!confirm('Revogar este acesso?'))return;await processAuth(id,'revogar','Acesso revogado com sucesso')};window.deleteAuth=async function(id){if(!confirm('Excluir esta autenticação?'))return;const csrf=document.querySelector('input[name="csrf_token"]').value;try{const response=await fetch(`/cliente/autenticacao/${id}`,{method:'DELETE',headers:{'Content-Type':'application/json','X-CSRF-Token':csrf},body:JSON.stringify({csrf_token:csrf})});const result=await response.json();if(result.sucesso){document.querySelector(`[data-auth-id="${id}"]`).remove();showMessage('success',result.mensagem)}else{showMessage('error',result.mensagem)}}catch(error){showMessage('error','Erro ao processar requisição')}};async function processAuth(id,action,successMsg){const csrf=document.querySelector('input[name="csrf_token"]').value;try{const response=await fetch(`/cliente/autenticacao/${action}/${id}`,{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-Token':csrf},body:JSON.stringify({csrf_token:csrf})});const result=await response.json();if(result.sucesso){showMessage('success',successMsg);setTimeout(()=>window.location.reload(),1000)}else{showMessage('error',result.mensagem)}}catch(error){showMessage('error','Erro ao processar requisição')}}function showError(field,message){const input=document.getElementById(field);const errorElement=document.getElementById(field+'-error');if(input)input.classList.add('error');if(errorElement){errorElement.textContent=message;errorElement.classList.add('show')}}function clearErrors(){document.querySelectorAll('.error-message').forEach(el=>{el.textContent='';el.classList.remove('show')});document.querySelectorAll('.form-control.error').forEach(el=>el.classList.remove('error'))}function showMessage(type,text){const container=document.getElementById('message-container');if(!container)return;const message=document.createElement('div');message.className=`message message-${type}`;message.innerHTML=`<span class="message-icon">${type==='success'?'✓':'✗'}</span><span class="message-text">${text}</span><button class="message-close" onclick="this.parentElement.remove()">×</button>`;container.appendChild(message);setTimeout(()=>message.remove(),5000);window.scrollTo({top:0,behavior:'smooth'})}window.showMessage=showMessage})();
